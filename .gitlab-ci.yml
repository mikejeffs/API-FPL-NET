image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_LOGIN_USER: ""
  DOCKER_LOGIN_PASSWORD: ""

stages:
  - build
  - test
  - publish

before_script:
  - docker login -u ${DOCKER_LOGIN_USER} -p ${DOCKER_LOGIN_PASSWORD} registry.gitlab.com

build:
  stage: build
  script:
    - echo "Building image"
    - docker build --tag api-fpl-net:latest .
    - docker save -o api-fpl-net.tar api-fpl-net:latest
  artifacts:
    paths:
      - api-fpl-net.tar

test:
  stage: test
  script:
    - echo "Running unit tests... NOT"

publish:
  stage: publish
  dependencies:
    - build
  script:
    - echo "Publishing image to gitlab registry"
    - docker load -i api-fpl-net.tar
    - docker tag api-fpl-net:latest registry.gitlab.com/msjp/api-fpl-net:latest
    - docker push registry.gitlab.com/msjp/api-fpl-net:latest
    - docker rmi api-fpl-net:latest